source .env
source .env.example

# Mint tokens for mock-usdc
# cast send --rpc-url $RPC_URL --private-key $STYLUS_LOCAL_DEV_PK $MOCK_USDC_ADDRESS "mint(uint256)" 100000000000

# Approve allowance for BalanceManager contract
cast send --rpc-url $RPC_URL --private-key $STYLUS_LOCAL_DEV_PK $MOCK_USDC_ADDRESS "approve(address,uint256)" $BALANCE_MANAGER_ADDRESS 10000000000

echo "Checking balance of MOCK_USDC for USER..."
cast call --rpc-url $RPC_URL $MOCK_USDC_ADDRESS "balanceOf(address)(uint256)" $USER_ADDRESS

# Deposit 1000 to the BalanceManager contract
cast send --rpc-url $RPC_URL --private-key $STYLUS_LOCAL_DEV_PK $BALANCE_MANAGER_ADDRESS "deposit(address,uint256)" $MOCK_USDC_ADDRESS 2000

# Check balances after deposit
echo "Checking user balance after deposit..."
cast call --rpc-url $RPC_URL $BALANCE_MANAGER_ADDRESS "getBalance(address,address)(uint256)" $USER_ADDRESS $MOCK_USDC_ADDRESS

# Check locked balances after deposit
echo "Checking user locked balance after deposit..."
cast call --rpc-url $RPC_URL $BALANCE_MANAGER_ADDRESS "getLockedBalance(address,address,address)(uint256)" $USER_ADDRESS $MOCK_USDC_ADDRESS $USER_ADDRESS

# Set operator (assign user address)
echo "Setting operator..."
cast send --rpc-url $RPC_URL --private-key $STYLUS_LOCAL_DEV_PK $BALANCE_MANAGER_ADDRESS "setOperator(address,bool)" $USER_ADDRESS true

# Lock 500 tokens
echo "Locking 500 tokens..."
cast send --rpc-url $RPC_URL --private-key $STYLUS_LOCAL_DEV_PK $BALANCE_MANAGER_ADDRESS "lock(address,address,address,uint256)" $USER_ADDRESS $USER_ADDRESS $MOCK_USDC_ADDRESS 1000

# Check balances for USER after transfer and unlock
echo "Checking USER balance after transfer and unlock..."
cast call --rpc-url $RPC_URL $BALANCE_MANAGER_ADDRESS "getBalance(address,address)(uint256)" $USER_ADDRESS $MOCK_USDC_ADDRESS

# Check locked balances for USER after transfer
echo "Checking USER locked balance after transfer..."
cast call --rpc-url $RPC_URL $BALANCE_MANAGER_ADDRESS "getLockedBalance(address,address,address)(uint256)" $USER_ADDRESS $MOCK_USDC_ADDRESS $USER_ADDRESS

# Transfer locked tokens to new user address
echo "Transferring locked tokens to new user address..."
cast send --rpc-url $RPC_URL --private-key $STYLUS_LOCAL_DEV_PK $BALANCE_MANAGER_ADDRESS "transferLocked(address,address,address,address,uint256)" $USER_ADDRESS $USER_ADDRESS $USER_2_ADDRESS $MOCK_USDC_ADDRESS 500

# Unlock remaining locked tokens
echo "Unlocking remaining locked tokens..."
cast send --rpc-url $RPC_URL --private-key $STYLUS_LOCAL_DEV_PK $BALANCE_MANAGER_ADDRESS "unlock(address,address,address,uint256)" $USER_ADDRESS $USER_ADDRESS $MOCK_USDC_ADDRESS 500

# Check balances for USER after transfer and unlock
echo "Checking USER balance after transfer and unlock..."
cast call --rpc-url $RPC_URL $BALANCE_MANAGER_ADDRESS "getBalance(address,address)(uint256)" $USER_ADDRESS $MOCK_USDC_ADDRESS

# Check locked balances for USER after transfer
echo "Checking USER locked balance after transfer..."
cast call --rpc-url $RPC_URL $BALANCE_MANAGER_ADDRESS "getLockedBalance(address,address,address)(uint256)" $USER_ADDRESS $MOCK_USDC_ADDRESS $USER_ADDRESS

# Check balances for USER_2 after transfer
echo "Checking USER_2 balance after transfer..."
cast call --rpc-url $RPC_URL $BALANCE_MANAGER_ADDRESS "getBalance(address,address)(uint256)" $USER_2_ADDRESS $MOCK_USDC_ADDRESS

# Withdraw 500 tokens from the BalanceManager contract
echo "Withdrawing 500 tokens..."
cast send --rpc-url $RPC_URL --private-key $STYLUS_LOCAL_DEV_PK $BALANCE_MANAGER_ADDRESS "withdraw(address,uint256)" $MOCK_USDC_ADDRESS 500

# Check balances after withdrawal
echo "Checking user balance after withdrawal..."
cast call --rpc-url $RPC_URL $BALANCE_MANAGER_ADDRESS "getBalance(address,address)(uint256)" $USER_ADDRESS $MOCK_USDC_ADDRESS

# Check locked balances after withdrawal
echo "Checking user locked balance after withdrawal..."
cast call --rpc-url $RPC_URL $BALANCE_MANAGER_ADDRESS "getLockedBalance(address,address,address)(uint256)" $USER_ADDRESS $MOCK_USDC_ADDRESS $USER_ADDRESS

echo "Checking balance of MOCK_USDC for USER..."
cast call --rpc-url $RPC_URL $MOCK_USDC_ADDRESS "balanceOf(address)(uint256)" $USER_ADDRESS